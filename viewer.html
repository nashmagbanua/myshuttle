<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABN Shuttle - Smart Viewer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    
    <style>
        #map { height: 100vh; width: 100%; background: #020617; }
        .sos-overlay { animation: pulse-red 1s infinite; }
        @keyframes pulse-red {
            0% { background: rgba(220, 38, 38, 0.8); }
            50% { background: rgba(220, 38, 38, 1); }
            100% { background: rgba(220, 38, 38, 0.8); }
        }
        .driver-label {
            background: #0f172a; border: 1px solid #38bdf8;
            color: white; font-weight: bold; padding: 2px 8px; border-radius: 4px;
        }
        /* Itago ang control panel ng routing machine */
        .leaflet-routing-container { display: none; }
    </style>
</head>
<body class="bg-slate-950 overflow-hidden text-white">

    <div id="sos-banner" class="hidden fixed top-0 w-full z-[1000] p-4 text-center text-white font-black text-xl sos-overlay shadow-2xl">
        ðŸš¨ EMERGENCY: SHUTTLE NEEDS HELP! ðŸš¨
    </div>

    <div id="map"></div>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] md:w-[400px] z-[1000] bg-slate-900/95 border border-slate-700 p-5 rounded-3xl shadow-2xl backdrop-blur-md">
        
        <div id="smart-suggestion" class="mb-4 p-4 bg-sky-500/10 border border-sky-500/30 rounded-2xl hidden">
            <p class="text-[10px] text-sky-400 font-bold uppercase mb-1 tracking-widest">Recommended Pickup Point</p>
            <div class="flex justify-between items-center">
                <h4 id="nearest-point-name" class="font-bold text-lg leading-tight">Searching...</h4>
                <button onclick="drawPath()" class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-xl text-xs font-black transition-all shadow-lg active:scale-95">WALK HERE</button>
            </div>
            <p id="nearest-point-dist" class="text-xs text-slate-400 mt-1 italic">Calculating distance...</p>
        </div>

        <div id="status-container" class="space-y-3">
            <p class="text-slate-500 text-xs italic text-center py-2">Waiting for shuttle signal...</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // --- 1. CONFIGURATION ---
        const SB_URL = 'https://qbeacrpoyfacgmbzxjcu.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZWFjcnBveWZhY2dtYnp4amN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NTM5NTIsImV4cCI6MjA2NDIyOTk1Mn0.6kfxKLJxidW4BcqsMJte61AtzydrTW-1ZJIJytiUBt4';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        const map = L.map('map', { zoomControl: false }).setView([14.25, 121.13], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // --- 2. PICKUP POINTS DATA ---
        const pickupPoints = [
            { name: "Main Gate", lat: 14.271839, lng: 121.122121 },
            { name: "ABN Company", lat: 14.258749, lng: 121.119243 },
            { name: "Package World Backgate", lat: 14.259227, lng: 121.119139 },
            { name: "Plant 2", lat: 14.260819, lng: 121.118248 },
            { name: "Calamba Start", lat: 14.205630, lng: 121.153511 },
            { name: "Parian", lat: 14.217508, lng: 121.143511 },
            { name: "Mamatid", lat: 14.229745, lng: 121.137991 },
            { name: "Banlic", lat: 14.232519, lng: 121.135631 },
            { name: "Banay-Banay", lat: 14.253159, lng: 121.128701 },
            { name: "Sala Cabuyao", lat: 14.267983, lng: 121.126553 }
        ];

        let shuttleMarkers = {};
        let userLocation = null;
        let userMarker = null;
        let routingControl = null;
        let nearestPoint = null;

        // Plot Pickup Points (Yellow Pins)
        pickupPoints.forEach(pt => {
            L.circleMarker([pt.lat, pt.lng], {
                radius: 6, fillColor: "#fbbf24", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
            }).addTo(map).bindTooltip(pt.name, { direction: 'top', className: 'text-[10px] font-bold' });
        });

        // --- 3. CORE FUNCTIONS ---

        // Watch Viewer Location
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                userLocation = [latitude, longitude];

                if (!userMarker) {
                    userMarker = L.circleMarker(userLocation, {
                        radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 3, opacity: 1, fillOpacity: 0.9
                    }).addTo(map).bindPopup("You are here");
                    map.setView(userLocation, 16);
                } else {
                    userMarker.setLatLng(userLocation);
                }
                findNearestPoint();
            }, (err) => console.error(err), { enableHighAccuracy: true });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function findNearestPoint() {
            if (!userLocation) return;
            let minVal = Infinity;

            pickupPoints.forEach(pt => {
                const dist = calculateDistance(userLocation[0], userLocation[1], pt.lat, pt.lng);
                if (dist < minVal) {
                    minVal = dist;
                    nearestPoint = pt;
                }
            });

            if (nearestPoint) {
                document.getElementById('smart-suggestion').classList.remove('hidden');
                document.getElementById('nearest-point-name').innerText = nearestPoint.name;
                const displayDist = minVal < 1 ? `${Math.round(minVal * 1000)}m away` : `${minVal.toFixed(2)}km away`;
                document.getElementById('nearest-point-dist').innerText = `Your closest pickup point (${displayDist})`;
            }
        }

        function drawPath() {
            if (!userLocation || !nearestPoint) return;
            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLocation[0], userLocation[1]), L.latLng(nearestPoint.lat, nearestPoint.lng)],
                routeWhileDragging: false,
                addWaypoints: false,
                lineOptions: { styles: [{ color: '#38bdf8', weight: 6, opacity: 0.8 }] },
                createMarker: function() { return null; }
            }).addTo(map);
        }

        function updateDisplay(data) {
            const { id, driver_name, latitude, longitude, speed, is_emergency } = data;
            const container = document.getElementById('status-container');

            // Update Shuttle Marker
            if (!shuttleMarkers[id]) {
                shuttleMarkers[id] = L.marker([latitude, longitude]).addTo(map)
                    .bindTooltip(driver_name, { permanent: true, direction: 'top', className: 'driver-label' });
            } else {
                shuttleMarkers[id].setLatLng([latitude, longitude]);
            }

            // Update UI Card
            let card = document.getElementById(`card-${id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${id}`;
                container.innerHTML = ""; 
                container.appendChild(card);
            }

            let shuttleDistText = "Tracking...";
            if (userLocation) {
                const d = calculateDistance(userLocation[0], userLocation[1], latitude, longitude);
                shuttleDistText = d < 1 ? `${Math.round(d * 1000)}m away` : `${d.toFixed(2)}km away`;
            }

            card.className = `p-4 rounded-2xl border transition-all ${is_emergency ? 'bg-red-900/30 border-red-500 animate-pulse shadow-[0_0_20px_rgba(239,68,68,0.4)]' : 'bg-slate-800 border-slate-700'}`;
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-black text-lg">${driver_name}</h4>
                        <p class="text-sky-400 font-bold text-sm">${shuttleDistText}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-black">${speed}</p>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">KM/H</p>
                    </div>
                </div>
            `;

            const banner = document.getElementById('sos-banner');
            is_emergency ? banner.classList.remove('hidden') : banner.classList.add('hidden');
        }

        // --- 4. DATA SYNC ---
        supabaseClient.channel('live').on('postgres_changes', { event: '*', schema: 'public', table: 'shuttle_tracking' }, p => updateDisplay(p.new)).subscribe();

        async function init() {
            const { data } = await supabaseClient.from('shuttle_tracking').select('*');
            if (data) data.forEach(d => updateDisplay(d));
        }
        init();
    </script>
</body>
</html>
