<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABN Shuttle - Monitor & Distance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; background: #020617; }
        .sos-overlay { animation: pulse-red 1s infinite; }
        @keyframes pulse-red {
            0% { background: rgba(220, 38, 38, 0.8); }
            50% { background: rgba(220, 38, 38, 1); }
            100% { background: rgba(220, 38, 38, 0.8); }
        }
        /* Custom Label Style */
        .driver-label {
            background: #0f172a;
            border: 1px solid #38bdf8;
            color: white;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-950 overflow-hidden">

    <div id="sos-banner" class="hidden fixed top-0 w-full z-[1000] p-4 text-center text-white font-black text-xl sos-overlay shadow-2xl">
        ðŸš¨ EMERGENCY: SHUTTLE NEEDS HELP! ðŸš¨
    </div>

    <div id="map"></div>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] md:w-96 z-[1000] bg-slate-900/95 border border-slate-700 p-5 rounded-3xl text-white shadow-2xl backdrop-blur-md">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-sky-400 text-sm tracking-widest uppercase">ABN Shuttle Tracker</h3>
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-[10px] text-slate-400 font-bold">LIVE</span>
            </div>
        </div>
        
        <div id="status-container" class="space-y-3">
            <p class="text-slate-500 text-xs italic text-center py-2">Waiting for shuttle signal and your location...</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SB_URL = 'https://qbeacrpoyfacgmbzxjcu.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZWFjcnBveWZhY2dtYnp4amN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NTM5NTIsImV4cCI6MjA2NDIyOTk1Mn0.6kfxKLJxidW4BcqsMJte61AtzydrTW-1ZJIJytiUBt4';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        const map = L.map('map', { zoomControl: false }).setView([14.5995, 120.9842], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let shuttleMarkers = {};
        let userLocation = null;
        let userCircle = null;

        // 1. GET VIEWER (EMPLOYEE) LOCATION
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                userLocation = [latitude, longitude];

                if (!userCircle) {
                    userCircle = L.circleMarker(userLocation, {
                        radius: 7, fillColor: "#3b82f6", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9
                    }).addTo(map).bindPopup("You are here");
                    map.setView(userLocation, 15);
                } else {
                    userCircle.setLatLng(userLocation);
                }
            }, (err) => console.error("User Location Error:", err), { enableHighAccuracy: true });
        }

        // 2. DISTANCE CALCULATOR (Haversine Formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius ng mundo in KM
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        // 3. UPDATE UI & MAP
        function updateDisplay(data) {
            const { id, driver_name, latitude, longitude, speed, is_emergency } = data;
            const container = document.getElementById('status-container');

            // Map Marker
            if (!shuttleMarkers[id]) {
                shuttleMarkers[id] = L.marker([latitude, longitude]).addTo(map)
                    .bindTooltip(driver_name, { permanent: true, direction: 'top', className: 'driver-label' });
            } else {
                shuttleMarkers[id].setLatLng([latitude, longitude]);
            }

            // Calculate Distance
            let distanceText = "Calculating distance...";
            if (userLocation) {
                const dist = calculateDistance(userLocation[0], userLocation[1], latitude, longitude);
                distanceText = dist < 1 ? `${Math.round(dist * 1000)} meters away` : `${dist.toFixed(2)} km away`;
            }

            // Update Card
            let card = document.getElementById(`card-${id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${id}`;
                container.innerHTML = ""; 
                container.appendChild(card);
            }

            card.className = `p-4 rounded-2xl border transition-all ${is_emergency ? 'bg-red-900/30 border-red-500 animate-pulse' : 'bg-slate-800 border-slate-700'}`;
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-black text-lg">${driver_name}</h4>
                        <p class="text-sky-400 font-bold text-sm">${distanceText}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-black">${speed}</p>
                        <p class="text-[10px] text-slate-500 font-bold uppercase">KM/H</p>
                    </div>
                </div>
            `;

            // SOS Banner
            const banner = document.getElementById('sos-banner');
            is_emergency ? banner.classList.remove('hidden') : banner.classList.add('hidden');

            // AUTO-ZOOM to fit both
            if (userLocation) {
                const bounds = L.latLngBounds([userLocation, [latitude, longitude]]);
                map.fitBounds(bounds, { padding: [70, 70], maxZoom: 15 });
            }
        }

        // 4. REALTIME LISTENER
        supabaseClient
            .channel('viewer-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'shuttle_tracking' }, payload => {
                updateDisplay(payload.new);
            })
            .subscribe();

        // Load Initial
        async function loadInitial() {
            const { data } = await supabaseClient.from('shuttle_tracking').select('*');
            if (data) data.forEach(d => updateDisplay(d));
        }
        loadInitial();
    </script>
</body>
</html>
